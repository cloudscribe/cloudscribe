(function() {
    "use strict";

    // Resolving TinyMCE PluginManager
    tinymce.util.Tools.resolve("tinymce.PluginManager").add("imageuploader", (editor) => {

        // Adding command to open the source imageuploader editor
        const addCommand = (editor) => {
            editor.addCommand("mceimageuploaderEditor", () => {
                openimageuploaderEditor(editor);
            });
        };

        // Function to open the source imageuploader editor window
        const openimageuploaderEditor = (editor) => {
            //const imageuploaderContent = getEditorContent(editor); // Get the current content in source view
            
            editor.windowManager.openUrl({
				title: '',
				url: '/filemanager/filedialog',
				height: 800,
				width: 1200,
				onSubmit: (dialog) => {
                    saveeditorcontent(editor, dialog.getdata().imageuploader); // save the new content
                    dialog.close(); // close the window
                },
				buttons: [
                    {
                        type: "cancel",
                        name: "cancel",
                        text: "Cancel"
                    }
                ],
			});
        };

        // Function to save new content into the editor
        const saveEditorContent = (editor, newContent) => {
            editor.focus();
            editor.undoManager.transact(() => {
                editor.setContent(newContent); // Set the new content
            });
            editor.selection.setCursorLocation();
            editor.nodeChanged(); // Notify the editor that the content has changed
        };

        // Adding the button and menu item for the source imageuploader editor
        const addButtonAndMenu = (editor) => {
            const onAction = () => editor.execCommand("mceimageuploaderEditor");

            editor.ui.registry.addButton("imageuploader", {
                icon: "edit-image",
                tooltip: "Images from the Server",
                onAction: onAction
            });

            editor.ui.registry.addMenuItem("imageuploader", {
                icon: "edit-image",
                text: "Images from the Server",
                onAction: onAction
            });
        };

        // Initialize the command and UI for the plugin
        addCommand(editor);
        addButtonAndMenu(editor);

        return {};
    });
	
	tinymce.PluginManager.requireLangPack("imageuploader", "cy, fr, it");
})();
